<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firma Transparente | Beta 1.0</title>
<link rel="icon" href="ico.png" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f8fafc;
    --bg-alt: #ffffff;
    --fg: #0f172a;
    --fg-muted: #64748b;
    --border: #e2e8f0;
    --primary: #4f46e5;
    --primary-hover: #4338ca;
    --shadow-color: 220 4% 59%;
    --shadow:
      0 3.8px 2.2px hsl(var(--shadow-color) / 0.02),
      0 9.2px 5.3px hsl(var(--shadow-color) / 0.028),
      0 17.3px 10px hsl(var(--shadow-color) / 0.035),
      0 30.8px 17.9px hsl(var(--shadow-color) / 0.042),
      0 57.7px 33.4px hsl(var(--shadow-color) / 0.05),
      0 138px 80px hsl(var(--shadow-color) / 0.07);
    --radius: 16px;
    --checker-a: #e5e7eb;
    --checker-b: #ffffff;
    --font-sans: 'Inter', system-ui, sans-serif;
  }
  body.dark {
    --bg: #0f172a;
    --bg-alt: #1e293b;
    --fg: #f1f5f9;
    --fg-muted: #94a3b8;
    --border: #334155;
    --primary: #818cf8;
    --primary-hover: #a78bfa;
    --shadow-color: 220 40% 2%;
    --checker-a: #334155;
    --checker-b: #1e293b;
  }
  body {
    font-family: var(--font-sans);
    background-color: var(--bg);
    color: var(--fg);
    margin: 0;
    padding: 24px;
    transition: background-color .25s, color .25s;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .container { max-width: 1100px; margin: auto; display: flex; flex-direction: column; gap: 24px; }
  h1, h2, h3 { margin: 0; font-weight: 700; }

  /* Hero */
  .hero {
    text-align: center;
    padding: 32px 24px;
    background-color: var(--bg-alt);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  .badge {
    display: inline-block;
    padding: 6px 14px;
    font-size: .8rem;
    font-weight: 700;
    background: linear-gradient(90deg, var(--primary), #a855f7);
    color: #fff;
    border-radius: 999px;
    margin-bottom: 16px;
    letter-spacing: 0.5px;
  }
  .hero h1 { font-size: 2.2rem; margin: 0 0 12px 0; line-height: 1.2; }
  .hero p { color: var(--fg-muted); margin-bottom: 24px; font-size: 1.1rem; max-width: 600px; margin-left: auto; margin-right: auto; }
  .chips { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  .chip {
    padding: 8px 16px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 999px;
    font-size: .85rem;
    font-weight: 500;
    transition: all .2s;
  }

  /* Layout */
  .main-grid { display: grid; gap: 24px; }
  @media(min-width: 900px) { .main-grid { grid-template-columns: 1fr 1fr; } }
  .card { background-color: var(--bg-alt); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow); }

  /* Área de Carga */
  .upload-area {
    border: 2px dashed var(--border);
    padding: 40px;
    border-radius: var(--radius);
    text-align: center;
    background-color: var(--bg);
    cursor: pointer;
    transition: all .25s ease-in-out;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
  }
  .upload-area:hover, .upload-area.dragover {
    border-color: var(--primary);
    background-color: var(--bg-alt);
    transform: translateY(-4px);
  }
  .upload-area.dragover {
    box-shadow: 0 0 30px var(--primary);
  }
  .upload-icon { color: var(--fg-muted); transition: all .2s; }
  .upload-area:hover .upload-icon, .upload-area.dragover .upload-icon {
    color: var(--primary);
  }

  /* Vista Previa */
  .preview-wrap {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    display: grid;
    place-items: center;
    min-height: 280px;
    background:
      linear-gradient(45deg, var(--checker-a) 25%, transparent 25%),
      linear-gradient(-45deg, var(--checker-a) 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, var(--checker-a) 75%),
      linear-gradient(-45deg, transparent 75%, var(--checker-a) 75%);
    background-size: 24px 24px;
    background-position: 0 0, 0 12px, 12px -12px, -12px 0;
    transition: all .2s;
  }
  .preview-wrap.white-bg { background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
  canvas { max-width: 100%; height: auto; transition: all .3s; }

  /* Controles */
  .controls-card {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .control label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 500; }
  input[type=range] {
    -webkit-appearance: none; appearance: none;
    width: 100%; height: 8px; background: var(--border);
    border-radius: 8px; outline: none; transition: all .2s;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none;
    width: 20px; height: 20px; border-radius: 50%;
    background: var(--primary); cursor: pointer;
    box-shadow: 0 0 0 3px var(--bg-alt), 0 0 0 5px var(--primary);
  }
  input[type=range]::-moz-range-thumb {
    width: 20px; height: 20px; border-radius: 50%;
    background: var(--primary); cursor: pointer;
  }
  .switch-container { display: flex; align-items: center; gap: 10px; margin-top: 16px; }
  .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 26px; }
  .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--primary); }
  input:checked + .slider:before { transform: translateX(24px); }

  /* Botones */
  .actions { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    border: none; padding: 12px 20px; border-radius: 999px;
    background: linear-gradient(90deg, var(--primary), #a855f7);
    color: #fff; font-weight: 700; cursor: pointer;
    box-shadow: var(--shadow); transition: all .2s;
  }
  .btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
  .btn-secondary { background: var(--bg-alt); color: var(--fg); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--bg); border-color: var(--fg-muted); }

  /* Pasos */
  .steps { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  .step-card {
    background: var(--bg-alt); padding: 24px; border-radius: var(--radius); text-align: center;
    display: flex; flex-direction: column; align-items: center; gap: 10px;
    box-shadow: var(--shadow); transition: all .2s;
  }
  .step-card:hover { transform: translateY(-5px); }
  .step-icon { font-size: 2.5rem; color: var(--primary); margin-bottom: 8px; }
  .step-card h3 { font-size: 1.1rem; }
  .step-card p { font-size: 0.9rem; color: var(--fg-muted); line-height: 1.5; margin: 0; }

  /* Footer & Policies */
  .policy-section {
    background-color: var(--bg-alt); padding: 24px; border-radius: var(--radius);
    box-shadow: var(--shadow); margin-top: 20px;
  }
  .policy-section h2 { margin-bottom: 12px; }
  .policy-section p { color: var(--fg-muted); line-height: 1.6; }
  .policy-section p i { color: var(--primary); font-style: normal; }
  .switches { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 24px; }
  footer { text-align: center; color: var(--fg-muted); font-size: .9rem; margin-top: 32px; }
  
  /* Overlay */
  .loading-overlay {
    position: fixed; inset: 0; background: rgba(15,23,42,.65); backdrop-filter: blur(8px);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 9999; color: #fff; opacity: 0; pointer-events: none; transition: opacity .25s;
  }
  .loading-overlay.active { opacity: 1; pointer-events: all; }
  .progress-ring { transform: rotate(-90deg); width: 80px; height: 80px; }
  .progress-ring__circle {
    stroke: #fff; stroke-width: 6; fill: transparent;
    stroke-linecap: round; transition: stroke-dashoffset 0.2s;
  }

  /* Visibilidad Inicial */
  .hidden { display: none !important; }

</style>
</head>
<body>
<div class="container">

  <section class="hero">
    <div class="badge" data-i18n-key="badge">Fase Beta 1.0</div>
    <h1 data-i18n-key="heroTitle">Quita el fondo de tu firma en segundos</h1>
    <p data-i18n-key="heroSubtitle">Sube tu imagen, ajusta la tolerancia y el suavizado, y obtén una firma con fondo transparente lista para usar.</p>
    <div class="chips">
      <div class="chip" data-i18n-key="chipFormats">Formatos: PNG, JPG, WebP</div>
      <div class="chip" data-i18n-key="chipEasy">Carga fácil por clic o arrastre</div>
      <div class="chip" data-i18n-key="chipMulti">Multi-idioma y tema</div>
    </div>
  </section>

  <div class="main-grid">
    <div>
      <section id="upload" class="upload-area">
        <div class="upload-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </div>
        <h3 data-i18n-key="uploadTitle">Arrastra o selecciona tu imagen</h3>
        <p class="fg-muted" data-i18n-key="uploadHint">Tamaño máximo 10MB</p>
        <input type="file" id="fileInput" accept="image/*" hidden>
      </section>

      <section id="previewContainer" class="preview-wrap hidden">
        <canvas id="resultCanvas"></canvas>
      </section>

      <div id="beforeAfterSwitch" class="switch-container justify-content-center hidden">
        <label data-i18n-key="before">Antes</label>
        <label class="switch">
          <input type="checkbox" id="beforeAfterToggle" checked>
          <span class="slider"></span>
        </label>
        <label data-i18n-key="after">Después</label>
      </div>
    </div>

    <div id="controlsCard" class="card controls-card hidden">
        <div class="control">
          <label for="tolerance"><span data-i18n-key="tolerance">Tolerancia</span><span id="tolVal">25</span></label>
          <input type="range" id="tolerance" min="1" max="100" value="25">
        </div>
        <div class="control">
          <label for="feather"><span data-i18n-key="feather">Suavizado</span><span id="featherVal">5</span></label>
          <input type="range" id="feather" min="0" max="40" value="5">
        </div>

      <div class="actions">
        <button id="downloadBtn" class="btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          <span data-i18n-key="download">Descargar</span>
        </button>
        <button id="resetBtn" class="btn btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
          <span data-i18n-key="reset">Restaurar</span>
        </button>
      </div>
      <p class="hint" style="font-size: 0.9rem; color: var(--fg-muted); margin-top: 15px;"><i data-i18n-key="hintTip">Tip: usa imágenes con fondo uniforme y buena iluminación para mejores resultados.</i></p>
    </div>
  </div>

  <section class="steps">
    <div class="step-card">
        <div class="step-icon">📂</div>
        <h3 data-i18n-key="step1Title">1. Sube tu imagen</h3>
        <p data-i18n-key="step1Desc">Elige un PNG o JPG con bordes claros entre el texto y el fondo.</p>
    </div>
    <div class="step-card">
        <div class="step-icon">🎚️</div>
        <h3 data-i18n-key="step2Title">2. Ajusta los parámetros</h3>
        <p data-i18n-key="step2Desc">Modifica la tolerancia y el suavizado para un recorte perfecto.</p>
    </div>
    <div class="step-card">
        <div class="step-icon">⬇️</div>
        <h3 data-i18n-key="step3Title">3. Descarga y usa</h3>
        <p data-i18n-key="step3Desc">Exporta como PNG transparente o copia al portapapeles para usar al instante.</p>
    </div>
  </section>

  <div class="main-grid">
      <section id="privacy-policy" class="policy-section">
        <h2 data-i18n-key="privacyTitle">Política de Privacidad</h2>
        <p data-i18n-key="privacyDesc1">
          Esta aplicación procesa las imágenes únicamente en tu dispositivo. No se almacenan, comparten ni envían archivos a servidores externos. No recopilamos datos personales ni utilizamos tus imágenes para ningún propósito distinto al procesamiento solicitado por el usuario.
        </p>
        <p data-i18n-key="privacyDesc2">
          Si tienes dudas sobre la privacidad, puedes contactarnos a través del correo <i>agente.chococreativo@gmail.com.</i>
        </p>
      </section>

      <section id="settings" class="policy-section">
        <h2 data-i18n-key="settingsTitle">Configuración</h2>
        <p data-i18n-key="settingsDesc">
          Este sitio no utiliza cookies de seguimiento. Cambia el idioma o el tema visual según tu preferencia.
        </p>
        <div class="switches">
          <button id="langSwitch" class="btn btn-secondary"></button>
          <button id="themeSwitch" class="btn btn-secondary"></button>
        </div>
      </section>
  </div>
  
  <footer>© 2025 by Kevin Hurtado. Fase beta. Todos los derechos reservados.</footer>
</div>

<div id="loadingOverlay" class="loading-overlay">
  <svg class="progress-ring"><circle class="progress-ring__circle" r="36" cx="40" cy="40"/></svg>
  <div id="loadingText" style="margin-top:10px;" data-i18n-key="processing">Procesando...</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // ======== DICCIONARIO DE TRADUCCIONES ========
  const translations = {
    es: {
      badge: "Fase Beta 1.0",
      heroTitle: "Quita el fondo de tu firma en segundos",
      heroSubtitle: "Sube tu imagen, ajusta la tolerancia y el suavizado, y obtén una firma con fondo transparente lista para usar.",
      chipFormats: "Formatos: PNG, JPG, WebP",
      chipEasy: "Carga fácil por clic o arrastre",
      chipMulti: "Multi-idioma y tema",
      uploadTitle: "Arrastra o selecciona tu imagen",
      uploadHint: "Tamaño máximo 10MB",
      before: "Antes",
      after: "Después",
      tolerance: "Tolerancia",
      feather: "Suavizado",
      download: "Descargar",
      reset: "Restaurar",
      hintTip: "Tip: usa imágenes con fondo uniforme y buena iluminación para mejores resultados.",
      step1Title: "1. Sube tu imagen",
      step1Desc: "Elige un PNG o JPG con bordes claros entre el texto y el fondo.",
      step2Title: "2. Ajusta los parámetros",
      step2Desc: "Modifica la tolerancia y el suavizado para un recorte perfecto.",
      step3Title: "3. Descarga y usa",
      step3Desc: "Exporta como PNG transparente o copia al portapapeles para usar al instante.",
      privacyTitle: "Política de Privacidad",
      privacyDesc1: "Esta aplicación procesa las imágenes únicamente en tu dispositivo. No se almacenan, comparten ni envían archivos a servidores externos. No recopilamos datos personales ni utilizamos tus imágenes para ningún propósito distinto al procesamiento solicitado por el usuario.",
      privacyDesc2: "Si tienes dudas sobre la privacidad, puedes contactarnos a través del correo <i>agente.chococreativo@gmail.com.</i>",
      settingsTitle: "Configuración",
      settingsDesc: "Este sitio no utiliza cookies de seguimiento. Cambia el idioma o el tema visual según tu preferencia.",
      langBtn: "🌐 English",
      themeBtnDark: "🌙 Modo Oscuro",
      themeBtnLight: "☀️ Modo Claro",
      processing: "Procesando..."
    },
    en: {
      badge: "Beta Phase 1.0",
      heroTitle: "Remove your signature's background in seconds",
      heroSubtitle: "Upload your image, adjust tolerance and feather, and get a transparent background signature ready to use.",
      chipFormats: "Formats: PNG, JPG, WebP",
      chipEasy: "Easy upload by click or drag",
      chipMulti: "Multi-language & theme",
      uploadTitle: "Drag or select your image",
      uploadHint: "Maximum size 10MB",
      before: "Before",
      after: "After",
      tolerance: "Tolerance",
      feather: "Feather",
      download: "Download",
      reset: "Reset",
      hintTip: "Tip: use images with a uniform background and good lighting for best results.",
      step1Title: "1. Upload your image",
      step1Desc: "Choose a PNG or JPG with clear edges between the text and background.",
      step2Title: "2. Adjust parameters",
      step2Desc: "Modify tolerance and feather for a perfect cutout.",
      step3Title: "3. Download and use",
      step3Desc: "Export as a transparent PNG or copy to the clipboard for instant use.",
      privacyTitle: "Privacy Policy",
      privacyDesc1: "This application processes images solely on your device. No files are stored, shared, or sent to external servers. We do not collect personal data or use your images for any purpose other than the processing requested by the user.",
      privacyDesc2: "If you have questions about privacy, you can contact us via email at <i>agente.chococreativo@gmail.com.</i>",
      settingsTitle: "Settings",
      settingsDesc: "This site does not use tracking cookies. Change the language or visual theme according to your preference.",
      langBtn: "🌐 Español",
      themeBtnDark: "🌙 Dark Mode",
      themeBtnLight: "☀️ Light Mode",
      processing: "Processing..."
    }
  };

  // ======== ELEMENTOS DEL DOM ========
  const getEl = (id) => document.getElementById(id);
  const UIElements = {
    uploadArea: getEl('upload'),
    fileInput: getEl('fileInput'),
    previewContainer: getEl('previewContainer'),
    resultCanvas: getEl('resultCanvas'),
    controlsCard: getEl('controlsCard'),
    beforeAfterSwitch: getEl('beforeAfterSwitch'),
    beforeAfterToggle: getEl('beforeAfterToggle'),
    tolSlider: getEl('tolerance'),
    featherSlider: getEl('feather'),
    tolVal: getEl('tolVal'),
    featherVal: getEl('featherVal'),
    downloadBtn: getEl('downloadBtn'),
    resetBtn: getEl('resetBtn'),
    langSwitch: getEl('langSwitch'),
    themeSwitch: getEl('themeSwitch'),
    loadingOverlay: getEl('loadingOverlay'),
    progressRing: document.querySelector('.progress-ring__circle'),
  };

  // ======== ESTADO DE LA APLICACIÓN ========
  const AppState = {
    imgOriginal: null,
    workCanvas: document.createElement('canvas'),
    originalCanvas: document.createElement('canvas'),
    currentLang: localStorage.getItem("lang") || "es",
    isDarkMode: localStorage.getItem("theme") === "dark",
  };

  // ======== LÓGICA DE UI: IDIOMA Y TEMA ========
  function applyLanguage(lang) {
    const t = translations[lang];
    document.querySelectorAll('[data-i18n-key]').forEach(el => {
      const key = el.getAttribute('data-i18n-key');
      if (t[key]) {
        el.innerHTML = t[key];
      }
    });
    UIElements.langSwitch.textContent = t.langBtn;
    updateThemeButtonText(); // Actualiza texto del botón de tema
  }
  
  function updateThemeButtonText() {
      const key = AppState.isDarkMode ? 'themeBtnLight' : 'themeBtnDark';
      UIElements.themeSwitch.textContent = translations[AppState.currentLang][key];
  }

  function applyTheme(isDark) {
    document.body.classList.toggle("dark", isDark);
    updateThemeButtonText();
  }
  
  UIElements.langSwitch.addEventListener("click", () => {
    AppState.currentLang = AppState.currentLang === "es" ? "en" : "es";
    localStorage.setItem("lang", AppState.currentLang);
    applyLanguage(AppState.currentLang);
  });
  
  UIElements.themeSwitch.addEventListener("click", () => {
    AppState.isDarkMode = !AppState.isDarkMode;
    localStorage.setItem("theme", AppState.isDarkMode ? "dark" : "light");
    applyTheme(AppState.isDarkMode);
  });

  // ======== LÓGICA DE CARGA (OVERLAY) ========
  const radius = UIElements.progressRing.r.baseVal.value;
  const circumference = 2 * Math.PI * radius;
  UIElements.progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
  UIElements.progressRing.style.strokeDashoffset = circumference;

  function setProgress(percent) {
    const offset = circumference - (percent / 100) * circumference;
    UIElements.progressRing.style.strokeDashoffset = offset;
  }
  
  function showLoading(show) {
    UIElements.loadingOverlay.classList.toggle('active', show);
    if(show) setProgress(0);
  }

  // ======== LÓGICA DE PROCESAMIENTO DE IMAGEN ========
  const rgbToLab = (r, g, b) => {
      r /= 255; g /= 255; b /= 255;
      r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
      g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
      b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
      let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
      let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.0000;
      let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;
      x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x) + 16/116;
      y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y) + 16/116;
      z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z) + 16/116;
      return [(116 * y) - 16, 500 * (x - y), 200 * (y - z)];
  };

  const computeBackgroundColor = (imageData, w, h) => {
      const d = imageData.data; let r=0,g=0,b=0,count=0;
      const step = Math.max(2, Math.floor(Math.min(w, h) / 100));
      for (let y = 0; y < h; y += step) {
          for (let x = 0; x < w; x += step) {
              if (x > step && x < w - step && y > step && y < h - step) continue;
              const i = (y * w + x) * 4; r += d[i]; g += d[i+1]; b += d[i+2]; count++;
          }
      }
      return count === 0 ? [d[0], d[1], d[2]] : [Math.round(r/count), Math.round(g/count), Math.round(b/count)];
  };

  function processCurrentImage() {
    if (!AppState.imgOriginal) return;

    showLoading(true);
    let progress = 0;
    const interval = setInterval(() => { progress = Math.min(progress + 5, 90); setProgress(progress); }, 80);

    // Usar requestAnimationFrame para no bloquear el hilo principal
    requestAnimationFrame(async () => {
        const ctx = AppState.workCanvas.getContext('2d', { willReadFrequently: true });
        AppState.workCanvas.width = AppState.imgOriginal.naturalWidth;
        AppState.workCanvas.height = AppState.imgOriginal.naturalHeight;
        ctx.drawImage(AppState.imgOriginal, 0, 0);

        const { width: w, height: h } = AppState.workCanvas;
        const imageData = ctx.getImageData(0, 0, w, h);
        const [bgR, bgG, bgB] = computeBackgroundColor(imageData, w, h);
        const bgLab = rgbToLab(bgR, bgG, bgB);

        const d = imageData.data;
        const tol = parseInt(UIElements.tolSlider.value, 10);
        const soft = parseInt(UIElements.featherSlider.value, 10);
        const tolMin = Math.max(0, tol - soft);
        const tolMax = tol + soft;

        for (let i = 0; i < d.length; i += 4) {
            const pxLab = rgbToLab(d[i], d[i+1], d[i+2]);
            const deltaE = Math.hypot(pxLab[0] - bgLab[0], pxLab[1] - bgLab[1], pxLab[2] - bgLab[2]);
            if (deltaE <= tolMin) {
                d[i+3] = 0;
            } else if (deltaE < tolMax) {
                d[i+3] = Math.round(d[i+3] * ((deltaE - tolMin) / soft));
            }
        }
        ctx.putImageData(imageData, 0, 0);

        drawProcessed();
        UIElements.beforeAfterToggle.checked = true; // Asegurarse de que el toggle muestre 'Después'
        
        clearInterval(interval);
        setProgress(100);
        await new Promise(resolve => setTimeout(resolve, 300));
        showLoading(false);
    });
  }

  // ======== LÓGICA DE DIBUJADO Y MANEJO DE ARCHIVOS ========
  const drawProcessed = () => {
    UIElements.previewContainer.classList.remove('white-bg');
    const outCtx = UIElements.resultCanvas.getContext('2d');
    UIElements.resultCanvas.width = AppState.workCanvas.width;
    UIElements.resultCanvas.height = AppState.workCanvas.height;
    outCtx.clearRect(0, 0, AppState.workCanvas.width, AppState.workCanvas.height);
    outCtx.drawImage(AppState.workCanvas, 0, 0);
  };

  const drawOriginal = () => {
    UIElements.previewContainer.classList.add('white-bg');
    const outCtx = UIElements.resultCanvas.getContext('2d');
    UIElements.resultCanvas.width = AppState.originalCanvas.width;
    UIElements.resultCanvas.height = AppState.originalCanvas.height;
    outCtx.clearRect(0, 0, AppState.originalCanvas.width, AppState.originalCanvas.height);
    outCtx.drawImage(AppState.originalCanvas, 0, 0);
  };
  
  function showEditorUI(show) {
      UIElements.uploadArea.classList.toggle('hidden', show);
      UIElements.previewContainer.classList.toggle('hidden', !show);
      UIElements.controlsCard.classList.toggle('hidden', !show);
      UIElements.beforeAfterSwitch.classList.toggle('hidden', !show);
  }

  function handleFile(file) {
    if (!file.type.startsWith('image/')) return alert('Por favor, selecciona un archivo de imagen.');
    if (file.size > 10 * 1024 * 1024) return alert('El archivo es demasiado grande (máx 10MB).');

    showLoading(true);
    const img = new Image();
    img.onload = () => {
      AppState.imgOriginal = img;
      AppState.originalCanvas.width = img.width;
      AppState.originalCanvas.height = img.height;
      AppState.originalCanvas.getContext('2d').drawImage(img, 0, 0);
      
      showEditorUI(true);
      processCurrentImage();
    };
    img.onerror = () => {
        alert("No se pudo cargar la imagen. Intenta con otro archivo.");
        showLoading(false);
    }
    img.src = URL.createObjectURL(file);
  }
  
  // ======== EVENT LISTENERS ========
  UIElements.uploadArea.addEventListener('click', () => UIElements.fileInput.click());
  UIElements.fileInput.addEventListener('change', e => { if(e.target.files[0]) handleFile(e.target.files[0]) });

  // Drag & Drop
  UIElements.uploadArea.addEventListener('dragover', e => { e.preventDefault(); UIElements.uploadArea.classList.add('dragover'); });
  UIElements.uploadArea.addEventListener('dragleave', () => UIElements.uploadArea.classList.remove('dragover'));
  UIElements.uploadArea.addEventListener('drop', e => {
    e.preventDefault();
    UIElements.uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
  });
  
  // Controles
  const updateAndProcess = () => {
    UIElements.tolVal.textContent = UIElements.tolSlider.value;
    UIElements.featherVal.textContent = UIElements.featherSlider.value;
    processCurrentImage();
  };
  UIElements.tolSlider.addEventListener('input', () => {
      UIElements.tolVal.textContent = UIElements.tolSlider.value;
  });
  UIElements.tolSlider.addEventListener('change', processCurrentImage); // Procesa al soltar
  UIElements.featherSlider.addEventListener('input', () => {
      UIElements.featherVal.textContent = UIElements.featherSlider.value;
  });
  UIElements.featherSlider.addEventListener('change', processCurrentImage); // Procesa al soltar

  UIElements.beforeAfterToggle.addEventListener('change', () => {
    UIElements.beforeAfterToggle.checked ? drawProcessed() : drawOriginal();
  });

  UIElements.resetBtn.addEventListener('click', () => {
    UIElements.tolSlider.value = 25;
    UIElements.featherSlider.value = 5;
    updateAndProcess();
  });

  UIElements.downloadBtn.addEventListener('click', () => {
    const a = document.createElement('a');
    a.download = 'firma_transparente.png';
    a.href = UIElements.resultCanvas.toDataURL('image/png');
    a.click();
  });

  function init() {
    applyTheme(AppState.isDarkMode);
    applyLanguage(AppState.currentLang);
    showEditorUI(false);
  }
  
  init();
});
</script>
</body>

</html>
